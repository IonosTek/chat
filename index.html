<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IonosTek Link</title>
    <style>
        /* --- GLOBAL & LAYOUT --- */
        body { 
            margin: 0; 
            background-color: #0f172a; 
            font-family: 'Segoe UI', sans-serif; 
            color: white; 
            /* ‡πÉ‡∏ä‡πâ dvh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡∏£‡∏ß‡∏°‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏∂‡πâ‡∏ô) */
            height: 100dvh; 
            display: flex; 
            overflow: hidden; 
        }
        
        /* LOGIN SCREEN */
        #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0f172a; z-index: 100; transition: top 0.5s ease-in-out; }
        .card { background-color: #1e293b; padding: 30px; border-radius: 12px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); border: 1px solid #334155; }
        input.login-input { width: 100%; padding: 12px; margin: 15px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 6px; box-sizing: border-box; text-align: center; font-size: 16px; }
        button.primary-btn { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }

        /* APP CONTAINER */
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; } 
        
        /* CHAT AREA */
        #chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1e293b; position: relative; height: 100%; }
        #header { padding: 15px; background: #1e293b; border-bottom: 1px solid #334155; font-weight: bold; display: flex; align-items: center; flex-shrink: 0; }
        .freq-badge { background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px; }

        /* Messages Area */
        #messages { 
            flex: 1; 
            list-style-type: none; 
            margin: 0; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            padding-bottom: 20px;
        }
        
        /* MESSAGES STYLES */
        .msg { padding: 10px 12px; border-radius: 6px; max-width: 80%; word-wrap: break-word; font-size: 14px; line-height: 1.4; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg.system { align-self: center; background: rgba(251, 191, 36, 0.1); color: #fbbf24; font-size: 12px; border: 1px solid rgba(251, 191, 36, 0.3); padding: 4px 15px; border-radius: 20px; margin-bottom: 5px; text-align: center; }
        .msg.others { align-self: flex-start; background: #334155; border-bottom-left-radius: 0; }
        .msg.me { align-self: flex-end; background: #2563eb; border-bottom-right-radius: 0; }
        
        .meta { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: flex; justify-content: space-between; gap: 10px; }
        .username { font-weight: bold; color: #93c5fd; }
        .chat-image { max-width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .file-link { color: #fff; text-decoration: underline; display: block; margin-top: 5px; }

        /* INPUT AREA */
        #form { 
            display: flex; 
            padding: 10px; 
            background: #1e293b; 
            border-top: 1px solid #334155; 
            align-items: center; 
            flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏î‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î */
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πâ‡∏á‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ô iOS */
            position: sticky; 
            bottom: 0;
            padding-bottom: env(safe-area-inset-bottom, 10px); /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iPhone ‡∏à‡∏≠‡πÅ‡∏´‡∏ß‡πà‡∏á */
        }
        
        #input-msg { flex: 1; text-align: left; margin: 0 8px; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; font-size: 16px; /* 16px ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô iOS ‡∏ã‡∏π‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå */ }
        
        /* Buttons */
        .icon-btn { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; background: #475569; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 18px; }
        #send-btn { width: 60px; background: #3b82f6; font-weight: bold; font-size: 14px; margin-left: 8px; }

        /* SIDEBAR */
        #sidebar { width: 250px; background: #111827; display: flex; flex-direction: column; padding: 20px; border-left: 1px solid #334155; }
        #sidebar h3 { margin: 0 0 20px 0; font-size: 14px; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        #user-list { list-style: none; padding: 0; margin: 0; }
        .user-item { padding: 8px 12px; background: #1f2937; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; font-size: 14px; border: 1px solid #374151; }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px #22c55e; }

        @media (max-width: 600px) { #sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card">
            <h2>IONOSTEK</h2>
            <p style="color:#94a3b8; margin-top:0;">Secure Data Link</p>
            <input id="username" class="login-input" placeholder="Callsign / Name" autocomplete="off" />
            <button id="join-btn" class="primary-btn">CONNECT</button>
        </div>
    </div>

    <div id="app-container">
        <div id="chat-section">
            <div id="header">
                <span class="freq-badge">DATA LINK</span> IonosTek Channel
            </div>
            <ul id="messages"></ul>
            
            <form id="form">
                <input type="file" id="file-input" hidden>
                <button type="button" class="icon-btn" id="clip-btn">üìé</button>
                <input id="input-msg" autocomplete="off" placeholder="Type..." />
                <button id="send-btn" class="icon-btn">‚û§</button>
            </form>
        </div>

        <div id="sidebar">
            <h3>Online Stations</h3>
            <ul id="user-list"></ul>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username');
        const joinBtn = document.getElementById('join-btn');
        const form = document.getElementById('form');
        const inputMsg = document.getElementById('input-msg');
        const messages = document.getElementById('messages');
        const userList = document.getElementById('user-list');
        const fileInput = document.getElementById('file-input');
        const clipBtn = document.getElementById('clip-btn');

        function renderMessage(data) {
            const item = document.createElement('li');
            if (data.type === 'text') {
                const isMe = data.user === myName;
                item.className = isMe ? 'msg me' : 'msg others';
                item.innerHTML = `<div class="meta"><span class="username">${data.user}</span><span>${data.time}</span></div><div>${data.content}</div>`;
            } else if (data.type === 'file') {
                const isMe = data.user === myName;
                item.className = isMe ? 'msg me' : 'msg others';
                let contentHtml = data.fileType.startsWith('image/') 
                    ? `<img src="${data.content}" class="chat-image" onclick="window.open(this.src)">` 
                    : `üìÅ File: ${data.fileName} <a href="${data.content}" download="${data.fileName}" class="file-link">Download</a>`;
                item.innerHTML = `<div class="meta"><span class="username">${data.user}</span><span>${data.time}</span></div>${contentHtml}`;
            }
            if (!data.type && data.user === undefined) return;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        socket.on('system message', (text) => {
            const item = document.createElement('li');
            item.className = 'msg system';
            item.textContent = `[SYSTEM] ${text}`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        function updateUserList(users) {
            userList.innerHTML = ''; 
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                const style = (user === myName) ? 'color:#60a5fa; font-weight:bold;' : 'color:#e2e8f0;';
                li.innerHTML = `<span class="status-dot"></span><span style="${style}">${(user === myName) ? user + ' (YOU)' : user}</span>`;
                userList.appendChild(li);
            });
        }

        joinBtn.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (name) {
                myName = name;
                socket.emit('join', name);
                loginScreen.style.top = '-100%';
                setTimeout(() => { appContainer.style.opacity = '1'; }, 300);
            }
        });
        usernameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') joinBtn.click(); });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (inputMsg.value) {
                socket.emit('chat message', inputMsg.value);
                inputMsg.value = '';
                inputMsg.focus(); // Keep keyboard up
            }
        });

        clipBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { alert("Max 5MB"); return; }
                const reader = new FileReader();
                reader.onload = (e) => socket.emit('upload', { name: file.name, type: file.type, data: e.target.result });
                reader.readAsDataURL(file);
                this.value = '';
            }
        });

        socket.on('chat message', (data) => renderMessage(data));
        socket.on('load history', (history) => history.forEach(msg => renderMessage(msg)));
        socket.on('update user list', (users) => updateUserList(users));

        // Mobile viewport height fix
        function setVh() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setVh);
        setVh();
    </script>
</body>
</html>
