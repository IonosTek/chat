<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IonosTek Link</title>
    <style>
        /* --- GLOBAL & LAYOUT --- */
        body { margin: 0; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; color: white; height: 100vh; display: flex; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0f172a; z-index: 100; transition: top 0.5s ease-in-out; }
        .card { background-color: #1e293b; padding: 40px; border-radius: 12px; text-align: center; width: 320px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); border: 1px solid #334155; }
        input.login-input { width: 100%; padding: 12px; margin: 15px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 6px; box-sizing: border-box; text-align: center; font-size: 16px; }
        button.primary-btn { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button.primary-btn:hover { background: #1d4ed8; }

        /* APP CONTAINER */
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; } 
        
        /* CHAT AREA */
        #chat-section { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1e293b; position: relative; }
        #header { padding: 15px; background: #1e293b; border-bottom: 1px solid #334155; font-weight: bold; display: flex; align-items: center; }
        .freq-badge { background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px; }

        #messages { flex: 1; list-style-type: none; margin: 0; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        /* MESSAGES */
        .msg { padding: 10px 12px; border-radius: 6px; max-width: 70%; word-wrap: break-word; font-size: 14px; line-height: 1.4; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg.system { align-self: center; background: transparent; color: #fbbf24; font-size: 12px; border: 1px solid #fbbf24; padding: 4px 15px; border-radius: 20px; margin-bottom: 5px; width: auto; max-width: 90%; }
        .msg.others { align-self: flex-start; background: #334155; border-bottom-left-radius: 0; }
        .msg.me { align-self: flex-end; background: #2563eb; border-bottom-right-radius: 0; }
        
        .meta { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: flex; justify-content: space-between; gap: 10px; }
        .username { font-weight: bold; color: #93c5fd; }

        /* IMAGES IN CHAT */
        .chat-image { max-width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .file-link { color: #fff; text-decoration: underline; display: block; margin-top: 5px; }

        /* INPUT AREA */
        #form { display: flex; padding: 15px; background: #1e293b; border-top: 1px solid #334155; align-items: center; }
        #input-msg { flex: 1; text-align: left; margin: 0 10px; padding: 12px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; }
        
        /* Buttons */
        .icon-btn { width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; background: #475569; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 20px; transition: 0.2s; }
        .icon-btn:hover { background: #64748b; }
        #send-btn { width: 80px; background: #3b82f6; font-weight: bold; font-size: 14px; margin-left: 10px; }

        /* SIDEBAR */
        #sidebar { width: 250px; background: #111827; display: flex; flex-direction: column; padding: 20px; border-left: 1px solid #334155; }
        #sidebar h3 { margin: 0 0 20px 0; font-size: 14px; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        #user-list { list-style: none; padding: 0; margin: 0; }
        .user-item { padding: 8px 12px; background: #1f2937; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; font-size: 14px; border: 1px solid #374151; }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px #22c55e; }

        @media (max-width: 600px) { #sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card">
            <h2>IONOSTEK</h2>
            <p style="color:#94a3b8; margin-top:0;">Secure Data Link</p>
            <input id="username" class="login-input" placeholder="Callsign / Name" autocomplete="off" />
            <button id="join-btn" class="primary-btn">CONNECT</button>
        </div>
    </div>

    <div id="app-container">
        <div id="chat-section">
            <div id="header">
                <span class="freq-badge">DATA LINK</span> IonosTek Channel
            </div>
            <ul id="messages"></ul>
            
            <form id="form">
                <input type="file" id="file-input" hidden>
                <button type="button" class="icon-btn" id="clip-btn" title="Attach File">üìé</button>
                
                <input id="input-msg" autocomplete="off" placeholder="Type message..." />
                <button id="send-btn" class="icon-btn">‚û§</button>
            </form>
        </div>

        <div id="sidebar">
            <h3>Online Stations</h3>
            <ul id="user-list"></ul>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";

        // Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username');
        const joinBtn = document.getElementById('join-btn');
        const form = document.getElementById('form');
        const inputMsg = document.getElementById('input-msg');
        const messages = document.getElementById('messages');
        const userList = document.getElementById('user-list');
        const fileInput = document.getElementById('file-input');
        const clipBtn = document.getElementById('clip-btn');

        // --- FUNCTIONS ---

        function renderMessage(data) {
            const item = document.createElement('li');
            
            if (data.type === 'text') {
                // NORMAL TEXT
                const isMe = data.user === myName;
                item.className = isMe ? 'msg me' : 'msg others';
                item.innerHTML = `
                    <div class="meta"><span class="username">${data.user}</span><span>${data.time}</span></div>
                    <div>${data.content}</div>
                `;

            } else if (data.type === 'file') {
                // FILE / IMAGE
                const isMe = data.user === myName;
                item.className = isMe ? 'msg me' : 'msg others';
                
                let contentHtml = '';
                // Check if it is an image
                if (data.fileType.startsWith('image/')) {
                    contentHtml = `<img src="${data.content}" class="chat-image" onclick="window.open(this.src)">`;
                } else {
                    // Other files (PDF, ZIP, etc) -> Link
                    contentHtml = `üìÅ File: ${data.fileName} <a href="${data.content}" download="${data.fileName}" class="file-link">Download</a>`;
                }

                item.innerHTML = `
                    <div class="meta
